; =============================================================================
; OpenIPC / divinus IQ TEMPLATE (HiSilicon/Goke v4)
;
; Цель: короткий, понятный "скелет" для старта тюнинга нового сенсора.
; Просто скопируйте файл под имя вашего сенсора и правьте по месту.
;
; ВАЖНО:
; - HAL в divinus — это механизм. Тюнинг живёт тут.
; - Модуль применяется только если:
;     a) включен в [module_state] (если секция есть)
;     b) и есть соответствующая секция [static_*]/[dynamic_*]
; - Любая "маркетинговая" lowlight-логика включается ТОЛЬКО если вы добавили
;   соответствующие секции ([lowlight_fx], [lowlight_sharpen], [lowlight_drc_caps]).
;
; Единицы/шпаргалка:
; - ExpTime обычно в микросекундах (us). 10000 = 10ms.
; - Gain часто Q10: 1024 = 1.0x, 2048 = 2.0x, 4096 = 4.0x, 8192 = 8.0x и т.д.
; - 3DNR: divinus применяет только NRc параметры (-sfc/-tfc/-tpc/-trc) из 3DnrParam_*.
;
; Рекомендуемый workflow тюнинга:
; - Сначала добейтесь корректной экспозиции и цвета без "улучшайзеров":
;   AE + Saturation + CCM (Auto).
; - Потом подключайте DRC (dynamic_linear_drc) и 3DNR.
; - В самом конце — гамма/шарп (и только если не ломает снег/рассвет/ночь).
; =============================================================================

[module_state]
; 1 = применять секцию, 0 = пропустить (удобно временно отключать модули).
bStaticAE         = 1
bStaticCCM        = 1
bStaticSaturation = 1
bStaticLDCI       = 0
bStaticDehaze     = 0
bStaticDRC        = 0
bStaticNr         = 1
bStaticSharpen    = 1
; Gamma описывается секцией [dynamic_gamma]
bDynamicGamma     = 0
; Динамические (ISO-зависимые) модули
bDynamicDehaze    = 0
bDynamicLinearDRC = 1

[all_param]
; ISO hysteresis для ISO-зависимых профилей (3DNR/DRC/Dehaze).
; Можно не трогать, если нет "скачков" между соседними точками ISO.
UpFrameIso   = 400
DownFrameIso = 1000

; LowLightAutoAE — опционально, выключено по умолчанию.
; Включайте, если используете DAY ночью и хотите автопереключение на [lowlight_static_ae].
LowLightAutoAE  = 0
LowLightIso     = 800
LowLightExpTime = 12000

; Fast lowlight (anti-motion-blur) — опционально.
; При включенном LowLightAutoAE позволяет временами уменьшать выдержку.
LowLightFastLum        = 20
LowLightFastExpTimeMax = 20000
LowLightFastAGainMax   = 4096
LowLightFastCompBoost  = 0

[static_ae]
; БАЗОВЫЙ дневной AE.
; Если "всё слишком ярко" — первым делом снижайте AutoCompensation
; (и/или правьте экспозамер [static_aeweight]).
AERunInterval        = "1"
AERouteExValid       = "0"
AutoExpTimeMax       = "12000"
AutoAGainMax         = "8192"
AutoSysGainMax       = "1048576"
AutoCompensation     = "128"
AutoMaxHistOffset    = "24"
AutoHistRatioSlope   = "128"
AutoSpeed            = "64"
AutoTolerance        = "2"
AutoBlackDelayFrame  = "8"
AutoWhiteDelayFrame  = "0"

; --- Опционально (включайте вместе с LowLightAutoAE=1) ---
;[lowlight_static_ae]
;AERunInterval        = "1"
;AERouteExValid       = "0"
;; Дайте больше выдержки (меньше цифрового усиления => меньше шума)
;AutoExpTimeMax       = "33000"
;; Ограничьте аналоговый gain — уменьшает шум и "песок"
;AutoAGainMax         = "4096"
;AutoSysGainMax       = "1048576"
;; Обычно ночью нужно сделать "светлее" (увеличить), но следите за фонарями/снегом
;AutoCompensation     = "140"
;AutoMaxHistOffset    = "12"
;AutoHistRatioSlope   = "96"
;AutoSpeed            = "64"
;AutoTolerance        = "2"
;AutoBlackDelayFrame  = "8"
;AutoWhiteDelayFrame  = "0"

[static_aerouteex]
; ВНИМАНИЕ: некоторые GK SDK отвергают route-ex (illegal param). divinus сам отключит,
; если SDK ругнётся. Поэтому эта секция опциональна.
TotalNum        = "4"
RouteEXIntTime  = "    2,  8000, 15000, 33000"
RouteEXAGain    = " 1024,  2048,  4096,  8192"
RouteEXDGain    = " 1024,  1024,  1024,  2048"
RouteEXISPDGain = " 1024,  1024,  1024,  1024"

[static_aeweight]
; 15 строк по 17 значений. Это очень сильно влияет на "снег пересвечен" и "лица темные".
; Стартовый безопасный вариант — равномерный вес.
ExpWeight_0  = 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
ExpWeight_1  = 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
ExpWeight_2  = 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
ExpWeight_3  = 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
ExpWeight_4  = 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
ExpWeight_5  = 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
ExpWeight_6  = 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
ExpWeight_7  = 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
ExpWeight_8  = 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
ExpWeight_9  = 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
ExpWeight_10 = 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
ExpWeight_11 = 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
ExpWeight_12 = 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
ExpWeight_13 = 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
ExpWeight_14 = 1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,

[static_saturation]
; 16 значений (ISO points). Старт: нейтрально.
AutoSat = "128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128, 128"

[static_ccm]
; Если камера "синит на рассвете" — часто помогает мягкая manual CCM.
; Но CCM может быть отвергнут SDK (divinus залогирует и пропустит).
; 0=Auto, 1=Manual
CCMOpType = "0"
ISOActEn  = "0"
TempActEn = "0"

; --- Опционально: включите MANUAL CCM (пример слегка "теплее") ---
;CCMOpType = "1"
;ManualCCMTable = "1040,0,0, 0,1024,0, 0,0,1000"

[static_nr]
; 2D NR (ISP NR). Безопасно и полезно почти всегда.
Enable   = "1"
FineStr  = "40, 44, 48, 52, 56, 60, 64, 68, 72, 76, 80, 84, 88, 92, 96, 100"
CoringWgt = "20, 20, 18, 16, 14, 14, 12, 12, 10, 10, 10, 10, 10, 10, 10, 10"

[static_sharpen]
; Sharpen: если "песок"/шум усиливается — уменьшайте частоты и overshoot/undershoot,
; или временно поставьте Enable=0.
; Тут мы задаём ТОЛЬКО простые пер-ISO скаляры. Остальные таблицы остаются дефолтными
; из SDK (через GetIspSharpenAttr), что безопасно для нового сенсора.
Enable          = "1"
AutoTextureFreq = "170, 170, 170, 170, 170, 170, 170, 170, 160, 160, 160, 160, 160, 160, 160, 160"
AutoEdgeFreq    = "120, 120, 120, 120, 120, 120, 120, 120, 110, 110, 110, 110, 110, 110, 110, 110"
AutoOverShoot   = "40, 40, 40, 40, 40, 40, 40, 40, 25, 25, 25, 25, 15, 15, 15, 15"
AutoUnderShoot  = "80, 80, 80, 80, 80, 80, 80, 80, 50, 50, 50, 50, 20, 20, 20, 20"
AutoEdgeFiltStr = "50, 50, 50, 50, 50, 50, 50, 50, 55, 55, 55, 55, 55, 55, 55, 55"
AutoMaxSharpGain = "96, 96, 96, 96, 96, 96, 96, 96, 90, 90, 90, 90, 80, 80, 80, 80"

[dynamic_linear_drc]
; Рекомендуемый DRC для linear mode: ISO-зависимый, без "разноса" хайлайтов.
; Если снег/небо "молочные" — уменьшайте Bright* и Strength на низких ISO.
Enable               = "1"
IsoCnt               = "6"
IsoLevel             = "100, 200, 400, 800, 1600, 3200"
LocalMixingBrightMax = "18, 18, 17, 16, 15, 14"
LocalMixingBrightMin = "10, 10,  9,  9,  8,  7"
LocalMixingDarkMax   = "32, 32, 30, 28, 26, 24"
LocalMixingDarkMin   = "24, 24, 22, 20, 18, 16"
BrightGainLmt        = "4, 4, 4, 4, 5, 6"
BrightGainLmtStep    = "6, 6, 6, 6, 8, 8"
DarkGainLmtY         = "80, 80, 90, 95, 100, 110"
DarkGainLmtC         = "0, 0, 0, 0, 0, 0"
FltScaleCoarse       = "6, 6, 6, 6, 6, 6"
FltScaleFine         = "6, 6, 6, 6, 6, 6"
ContrastControl      = "8, 8, 8, 8, 9, 9"
DetailAdjustFactor   = "15, 15, 15, 15, 15, 15"
Asymmetry            = "1, 1, 2, 4, 6, 5"
SecondPole           = "150, 150, 150, 150, 160, 160"
Compress             = "110, 110, 120, 140, 150, 150"
Stretch              = "60, 60, 55, 55, 50, 50"
Strength             = "140, 135, 130, 120, 110, 100"

[static_3dnr]
; 3DNR (VPSS NRX) — на старте достаточно 3 точек.
; Параметры:
; - sfc (0..255): spatial filter compensation (сильнее => меньше шум, больше "смаз")
; - tfc/tpc (0..32): temporal filter/compensation
; - trc (0..255): temporal recursion
3DNRCount = "3"
IsoThresh = "100, 400, 1600"
3DnrParam_0 = "-sfc 60  -tfc 10 -tpc 10 -trc 12"
3DnrParam_1 = "-sfc 90  -tfc 12 -tpc 12 -trc 16"
3DnrParam_2 = "-sfc 130 -tfc 14 -tpc 14 -trc 20"

[dynamic_dehaze]
; Обычно лучше держать OFF на старте. Dehaze часто делает картинку "грязнее" и
; может ломать снег/небо.
Enable       = "0"
ExpThreshCnt = "6"
IsoThresh    = "100, 200, 400, 800, 1600, 3200"
AutoDehazeStr = "40, 45, 50, 60, 70, 75"

[dynamic_gamma]
; ВАЖНО: Gamma требует таблицу Table_0/1/2 (1025 значений). Поэтому в шаблоне OFF.
; Если хотите включить — возьмите готовую таблицу из рабочего профиля и вставьте.
Enable   = "0"
UseTable = "0"
;Table_0 = \
;0,1,2,... (1025 values)

; -----------------------------------------------------------------------------
; Опциональные lowlight "маркетинговые" секции (добавляйте при необходимости)
; -----------------------------------------------------------------------------
;[lowlight_fx]
;Enable = 1
;NoisyGammaIso      = 800
;NoisyGammaDGain    = 1200
;NoisyGammaISPDGain = 1200
;NoisySharpenIso      = 400
;NoisySharpenDGain    = 1100
;NoisySharpenISPDGain = 1150
;
;[lowlight_sharpen]
;Enable = 1
;OverShootScalePct  = 60
;UnderShootScalePct = 60
;MinOverShoot       = 8
;MinUnderShoot      = 8
;ShootSupStrMin     = 10
;EdgeFiltStrMin     = 60
;MaxSharpGainCap    = 72
;EdgeStrScalePct    = 85
;TextureStrScalePct = 85
;
;[lowlight_drc_caps]
;Enable                 = 1
;LowLightStrengthMax    = 140
;FastLowLightStrengthMax = 180
;BrightMixMax           = 8
;BrightMixMin           = 3
;BrightGainLmt          = 2
;BrightGainStep         = 3
;DarkMixMax             = 28
;DarkMixMin             = 20
;ContrastMax            = 8
;FastDarkMixMax         = 32
;FastDarkMixMin         = 24
;FastContrastMax        = 10

