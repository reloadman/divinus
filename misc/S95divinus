#!/bin/sh

DAEMON="divinus"
DAEMON_PATH="/usr/bin/$DAEMON"
PIDFILE="/run/$DAEMON.pid"
CHILD_PIDFILE="/run/${DAEMON}.child.pid"
DAEMON_ARGS=""
# Seconds to wait before respawn after crash
RESTART_DELAY="${RESTART_DELAY:-10}"

# shellcheck source=/dev/null
[ -r "/etc/default/$DAEMON" ] && . "/etc/default/$DAEMON"

# The daemon does not create a pidfile, and use "-m" to instruct start-stop-daemon to create one.
start() {
	printf 'Starting %s: ' "$DAEMON"
	if [ ! -x "$DAEMON_PATH" ]; then
		echo "MISSING ($DAEMON_PATH)"
		return 1
	fi
	# allow majestic/service to settle before starting divinus
	sleep 5
	# shellcheck disable=SC2086 # we need the word splitting for args
	start-stop-daemon -b -m -S -q -p "$PIDFILE" -x /bin/sh -- -c "
		# Ensure children die with the supervisor and exit the loop on stop
		trap '
			if [ -n \"\$child\" ]; then
				kill -TERM \"\$child\" 2>/dev/null
				wait \"\$child\" 2>/dev/null
				rm -f \"$CHILD_PIDFILE\"
			fi
			exit 0
		' INT TERM EXIT
		while true; do
			$DAEMON_PATH $DAEMON_ARGS &
			child=\$!
			echo \$child > \"$CHILD_PIDFILE\"
			wait \$child
			status=\$?
			logger -t $DAEMON \"exited with code \$status, restarting in $RESTART_DELAY s\"
			sleep $RESTART_DELAY
		done
	"
	status=$?
	if [ "$status" -eq 0 ]; then
		echo "OK"
	else
		echo "FAIL"
	fi
	return "$status"
}

stop() {
	printf 'Stopping %s: ' "$DAEMON"
	if [ -f "$PIDFILE" ] && start-stop-daemon -K -q -p "$PIDFILE" -s 0; then
		start-stop-daemon -K -q -p "$PIDFILE" --retry=TERM/3/KILL/2
		status=$?
		if [ "$status" -eq 0 ]; then
			rm -f "$PIDFILE"
			rm -f "$CHILD_PIDFILE"
			echo "OK"
		else
			echo "FAIL"
		fi
		return "$status"
	fi

	# Not running (or stale pidfile).
	rm -f "$PIDFILE"
	rm -f "$CHILD_PIDFILE"
	echo "not running"
	return 0
}

restart() {
	stop
	sleep 1
	start
}

reload() {
	printf 'Reloading %s (SIGHUP): ' "$DAEMON"
	if [ -f "$CHILD_PIDFILE" ]; then
		child=$(cat "$CHILD_PIDFILE" 2>/dev/null)
		case "$child" in
			''|*[!0-9]*) child= ;;
		esac
		if [ -n "$child" ] && kill -0 "$child" 2>/dev/null; then
			if kill -HUP "$child" 2>/dev/null; then
				echo "OK"
				return 0
			fi
		fi
	fi

	# If supervisor pid exists but child vanished, clean up to allow start.
	if [ -f "$PIDFILE" ] && ! start-stop-daemon -K -q -p "$PIDFILE" -s 0; then
		rm -f "$PIDFILE"
	fi

	rm -f "$CHILD_PIDFILE"
	echo "not running, starting..."
	start
}

case "$1" in
	start|stop|restart|reload)
		"$1";;
	*)
		echo "Usage: $0 {start|stop|restart|reload}"
		exit 1
esac
